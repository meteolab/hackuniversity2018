<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, width=device-width" />
<link rel="stylesheet" type="text/css" href="https://js.cit.api.here.com/v3/3.0/mapsjs-ui.css" />
<script type="text/javascript" src="https://js.cit.api.here.com/v3/3.0/mapsjs-core.js"></script>
<script type="text/javascript" src="https://js.cit.api.here.com/v3/3.0/mapsjs-service.js"></script>
<script type="text/javascript" src="https://js.cit.api.here.com/v3/3.0/mapsjs-ui.js"></script>
<script type="text/javascript" src="https://js.cit.api.here.com/v3/3.0/mapsjs-mapevents.js"></script>

<script type="text/javascript" src="mqttws31.js"></script>
</head>
<body>
  <div id="map" style="width: 100%; height: 500px; background: grey" />
  <script  type="text/javascript" charset="UTF-8" >



  
mqtt = new Paho.MQTT.Client("meteonet.io", Number(8883), "/", "browser-client");
mqtt.onConnectionLost = onConnectionLost;
mqtt.onMessageArrived = onMessageArrived;
mqtt.connect({onSuccess: function(){mqtt.subscribe("/hack2018");} });


function onConnectionLost(responseObject) {
    if(responseObject.errorCode !== 0) {
        console.log("onConnectionLost:"+responseObject.errorMessage);
    }
}

// Called when a message arrives
function onMessageArrived(message) {
    var topic     = message.destinationName;
    var payload   = message.payloadString;
    var array     = topic.split('/');
    var uuid      = array[0];
    var parameter = array[1];
    var data      = JSON.parse(payload);
    var lat       = data.lat;
    var lon       = data.lon;
    var value     = Math.round(parseFloat(data.value));
    //var E  = 610.78*10**(7.63*(T-273.15)/(T-31.25));
    //var RH = Math.round(e/E*100.0);
    //var t  = Math.round(T-273.15);
    //var p  = Math.round(data.airPressure*0.75/100.0);
    var element   = document.getElementById(parameter);
    replaceText(element, ""+value+"");
    var json = localStorage.getItem(uuid);
    //if(marker[uuid]!=null) {
    //    mymap.removeLayer(marker[uuid]);
    //}
    var markers = L.marker([lat, lon]).addTo(mymap);
    //markers.bindPopup("<b>"+t+"</b> &#176;C<br /><b>"+p+"</b> РјРј СЂС‚ СЃС‚<br /><b>"+RH+"</b> %<br />");
    // Delete previous record (without time check!)
    localStorage.removeItem(topic);
    // Save record in the Local Storage
    localStorage.setItem(topic, JSON.stringify(payload));
    // Read record from the Local Storage
    console.log("Length: " + localStorage.length);
    console.log("TOPIC: " + topic);
    console.log("PAYLOAD:\n" + JSON.parse(localStorage.getItem(topic)));

}



var platform = new H.service.Platform({
  app_id: 'pUOQk2ASMdS5JeoK3gYt',
  app_code: 'BPnxl9GdDtGuzhSDzotEPw',
  useCIT: true,
  useHTTPS: true
});
var defaultLayers = platform.createDefaultLayers();

var map = new H.Map(document.getElementById('map'),
  defaultLayers.normal.map,{
  center: {lat:59.9451, lng:30.3717},
  zoom: 10
});

var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

var coords = [{ lat:59.9655, lng:30.3700},
  { lat: 59.9404, lng: 30.3785 },
  { lat: 59.9249, lng: 30.3833 },
  { lat: 59.9288, lng: 30.3467 },
  { lat:59.9670, lng: 30.3333}];

// Временная ботва, заменяющая поток данных
var punk = prompt('Уровень загрязнения: ', 33);

coords.forEach(function (value, index) {
  var ind = 'Val:' + punk;
  // very-dark-red, dark-red, red, orange, yellow, green
  var colors = ["#600000","#a10000","#ff0000","#ff9d00","#efff00","#00ff1e"];
  var marker_color = (punk < 55) ? colors[5] :
    (punk < 155) ? colors[4] :
    (punk < 255) ? colors[3] :
    (punk < 355) ? colors[2] :
    (punk < 425) ? colors[1] :
    colors[0];
  var svgMarkup = '<svg width="64" height="24" xmlns="http://www.w3.org/2000/svg">' +
    '<rect stroke="white" fill="' + marker_color + '" x="1" y="1" width="62" height="22" />' +
    '<text x="5" y="18" font-size="12pt" font-family="Arial" font-weight="bold" ' +
    'text-anchor="left" fill="white">' + ind + '</text></svg>';
  var myIcon = new H.map.Icon(svgMarkup),
  marker = new H.map.Marker(value,  {icon: myIcon});


  marker.draggable = false;
  map.addObject(marker);
});

map.addEventListener('dragstart', function(ev) {
  var target = ev.target;
  if (target instanceof H.map.Marker) {
    behavior.disable();
  }
}, false);

map.addEventListener('drag', function(ev) {
  var target = ev.target,
      pointer = ev.currentPointer;
  if (target instanceof mapsjs.map.Marker) {
    target.setPosition(map.screenToGeo(pointer.viewportX, pointer.viewportY));
  }
}, false);

map.addEventListener('dragend', function(ev) {
  var target = ev.target;
  if (target instanceof mapsjs.map.Marker) {
    behavior.enable();
  }
}, false);



addClickEventListenerToMap(map);
  </script>
</body>
</html>